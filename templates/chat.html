<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gin WebSocket Chat</title>
    <script src="https://unpkg.com/htmx.org"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        #messages {
            height: 300px;
            overflow-y: scroll;
        }
    </style>
</head>
<body class="bg-dark">
    <div class="container py-5">
        <!-- Greeting box -->
        <div id="greeting" class="alert alert-primary text-center d-none"></div>

        <h1 class="text-center mb-4 text-light">WebSocket Chat</h1>

        <div id="messages" class="border border-secondary rounded p-3 bg-secondary mb-3"></div>

        <!-- Chat form -->
        <form id="chat-form" 
              class="d-flex gap-2"
              hx-post="/send" 
              hx-include="[name=message]" 
              hx-swap="none" 
              onsubmit="sendMessage(event)">
            <input type="text" 
                   name="message" 
                   class="form-control" 
                   placeholder="Type your message..." 
                   required 
                   disabled> <!-- Initially disabled -->
            <button type="submit" class="btn btn-primary" disabled>Send</button> <!-- Initially disabled -->
        </form>
    </div>

    <script>
        window.addEventListener('load', () => {
            const jwtToken = JSON.parse(localStorage.getItem('jwtToken'));
            const messageInput = document.querySelector("[name=message]");
            const sendButton = document.querySelector("button[type=submit]");
            let checker = false;

            if (jwtToken) {
                checker = true;

                // Fetch user claims
                fetch('/api/claim', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${jwtToken.accessToken}`,
                        'Accept': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Full Response Data:', data);

                    // Display the username in the greeting box
                    if (data.claims && data.claims.userName) {
                        const greetingDiv = document.getElementById('greeting');
                        greetingDiv.textContent = `Hi ${data.claims.userName}!`;
                        greetingDiv.classList.remove('d-none'); // Show the greeting box

                        // Enable the input and button
                        messageInput.disabled = false;
                        sendButton.disabled = false;
                    } else {
                        console.warn('Username not found in the claims object');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            } else {
                console.log("JWT Token is missing or invalid.");
            }

            // Initialize WebSocket only if checker is true
            if (checker) {
                
                const ws = new WebSocket("ws://192.168.59.133:8000/ws");

                // Listen for messages
                ws.onmessage = function(event) {
                    const messagesDiv = document.getElementById("messages");
                    const message = document.createElement("div");
                    const greetingDiv = document.getElementById('greeting');
                    const username = greetingDiv.textContent.replace("Hi ", "").replace("!", "").trim();
                    message.textContent = event.data;
                    message.className = "alert alert-info mb-2 p-2";
                    messagesDiv.appendChild(message);
                    messagesDiv.scrollTop = messagesDiv.scrollHeight; // Auto-scroll
                };

                // Send message on form submission
                window.sendMessage = function(event) {
                    event.preventDefault();
                    const input = document.querySelector("[name=message]");
                    const message = input.value;
                    const greetingDiv = document.getElementById('greeting');
                    const username = greetingDiv.textContent.replace("Hi ", "").replace("!", "").trim();
                    ws.send(JSON.stringify(username + " : " + message));
                    input.value = ""; // Clear the input
                };
            }
        });
    </script>
</body>
</html>
